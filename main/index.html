<html>

<head>
    <link rel="stylesheet" href="style.css">
    <script>
        var pins = [];

        function pintoggle(num, on) {
            const xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    getPins();
                }
            }
            xhr.open("POST", "/jsonrpc");
            xhr.send('{"jsonrpc": "2.0", "method": "' + (on ? "setpin" : "clearpin") + '", "params": {"pin":' + num + '}, "id": "1"}');
        }

        function restart() {
            const xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {

                }
            }
            xhr.open("POST", "/jsonrpc");
            xhr.send('{"jsonrpc": "2.0", "method": "restart", "params": {}, "id": "1"}');
        }

        function ota() {
            const xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {

                }
            }
            let url = document.getElementById("firmwarehost").value;
            xhr.open("POST", "/jsonrpc");
            xhr.send('{"jsonrpc": "2.0", "method": "ota", "params": {"upgrade_url": "' + url + '"}, "id": "1"}');
        }

        function modechange(s, num) {
            const xhr = new XMLHttpRequest();
            let newval = s.value;
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    location.reload();
                }
            }
            xhr.open("POST", "/jsonrpc");
            let msg = {
                jsonrpc: "2.0",
                method: "configpins",
                id: 1,
                params: {
                    outputs: pins.filter(p => (p.num == num ? (newval == 2) : (p.mode == 2))).map(p => { return { pin: p.num, maxon: 0 } }),
                    inputs: pins.filter(p => (p.num == num ? (newval == 1) : (p.mode == 1))).map(p => p.num)
                }
            };
            console.log(msg);
            xhr.send(JSON.stringify(msg));
        }

        function maxtimeChange(elem, pin) {
            let mt = elem.value;
            console.log(pin);
            console.log(mt);
            if (isNaN(mt)) return;
            mt = Number(mt);

            let params = {
                outputs: pins.filter(p => p.mode == 2).map(p => { return { pin: p.num, maxon: (p.num == pin ? mt : p.maxon) } }),
                inputs: pins.filter(p => p.mode == 1).map(p => p.num)
            };

            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    location.reload();
                }
            }
            xhr.open("POST", "/jsonrpc");
            let msg = {
                jsonrpc: "2.0",
                method: "configpins",
                id: 1,
                params: params,
            };
            console.log(msg);
            xhr.send(JSON.stringify(msg));
        }

        function createPinBox(p) {
            if (p.mode == 0x80) return "";

            let options = ["Disabled", "Input", "Output", "Analog"].map((elem, idx) => {
                let selected = "";
                if (p.mode == idx) selected = "selected";
                return "<option " + selected + " value=" + idx + ">" + elem + "</option>";
            });

            let maxtime = "";
            let button = "";
            let state = "";

            if (p.mode == 0) {
                state = "<span style=\"color:#c3c3c3;\">STATE_DISABLED</span>";
            } else if (p.mode == 1) {
                state = (p.state) ? "<span>STATE_OFF</span>" : "<span style=\"color:#00b7cb;\">STATE_ON</span>";
            } else if (p.mode == 2) {
                maxtime = "<input onchange=\"maxtimeChange(this, " + p.num + ")\" value=" + p.maxon + " />"
                button = "<button class=pinbutton onclick=\"pintoggle(" + p.num + "," + !p.state + ")\">Toggle</button>";
                state = (!p.state) ? "<span>STATE_OFF</span>" : "<span style=\"color:#00b7cb;\">STATE_ON</span>";
            } else if (p.mode == 3) { // Analog
                state = "<span>" + p.state + "</span>";
            }


            let h = "<div class=pins>";
            h += "<div class=pinscol1><b>" + p.num + "</b></div>";
            h += "<div class=pinscol2><select onchange=\"modechange(this, " + p.num + ")\">" + options.join("") + "</select></div>";
            h += "<div class=pinscol3>" + state + "</div>";
            h += "<div class=pinscol4>" + maxtime + "</div>";
            h += "<div class=pinscol5>" + button + "</div>";
            h += "</div>";
            return h;
        }

        function updatePins() {
            console.log(pins);
            let rows = pins.map((p) => {
                return createPinBox(p);
            })

            let rowHeader = "<div class=pins>";
            rowHeader += "<div class=pinscol1><b>Pin</b></div>";
            rowHeader += "<div class=pinscol2><b>Mode</b></div>";
            rowHeader += "<div class=pinscol3><b>State</b></div>";
            rowHeader += "<div class=pinscol4><b>Failsafe</b></div>";
            rowHeader += "<div class=pinscol5><b>Actions</b></div>";
            rowHeader += "</div>";


            rows.splice(0, 0, rowHeader);
            pinstable.innerHTML = rows.reduce((acc, current) => acc + current);
        }

        function getPins() {
            const xhr = new XMLHttpRequest();
            let pinstable = document.getElementById("pinstable");

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let status = JSON.parse(xhr.responseText).result;
                    pins.forEach(p => p.state = 0);
                    status.pins.forEach(element => {
                        pins[element].state = 1;
                    });
                    updatePins();
                }
            }
            xhr.open("POST", "/jsonrpc");
            xhr.send('{"jsonrpc": "2.0", "method": "getpins", "params": {}, "id": "1"}');

        }

        function getStatus() {
            const xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let status = JSON.parse(xhr.responseText).result;
                    document.getElementById("device").innerHTML = status.device;
                    document.getElementById("cores").innerHTML = status.cores;
                    document.getElementById("revision").innerHTML = status.silicon_revision_major + "." + status.silicon_revision_minor;
                    document.getElementById("flashsize").innerHTML = status.flash_size;
                    document.getElementById("mac").innerHTML = status.mac;
                    pins = status.pins.map((elem, idx) => {
                        return {
                            num: idx,
                            state: 0,
                            mode: elem.mode,
                            maxon: elem.maxon,
                        };
                    });

                    updatePins();
                }
            }
            xhr.open("POST", "/jsonrpc");
            xhr.send('{"jsonrpc": "2.0", "method": "status", "params": {}, "id": "1"}');

        }

        function init() {
            getStatus();
            getPins();
        }
    </script>
</head>

<body onload="init()">
    <div class="pins" style="height:170px">
        <table class="statustable">
            <tbody>
                <tr>
                    <td><b>Device</b></td>
                    <td><span id="device" /></td>
                </tr>
                <tr>
                    <td><b>Cores</b></td>
                    <td><span id="cores" /></td>
                </tr>
                <tr>
                    <td><b>Silicon revision</b></td>
                    <td><span id="revision" /></td>
                </tr>
                <tr>
                    <td><b>Flash Size</b></td>
                    <td><span id="flashsize" /></td>
                </tr>
                <tr>
                    <td><b>Mac</b></td>
                    <td><span id="mac" /></td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="pins" style="height:180px; display:block">
        <div style="border-bottom: 1px solid #C7C7C7; padding:10px;margin-top:10px;display:flex">
            <div style="width:20%"><b>Restart Device</b></div>
            <div style="width:50%"></div>
            <div style="width:30%;text-align: right;">
                <button onclick="restart()">
                    Restart
                </button>
            </div>
        </div>
        <div style="padding:10px;margin-top:40px;display:flex">
            <div style="width:20%"><b>Firmware Update</b></div>
            <div style="width:50%"><input style="width:450px" id="firmwarehost"
                    value="http://192.168.1.3:8113/dwn.bin" />
            </div>
            <div style="width:30%;text-align: right;"><button onclick="ota()">Update</button>
            </div>
        </div>
    </div>

    </div>
    </div>
    <div id="pinstable">
    </div>
</body>

</html>